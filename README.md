# C. Elegans shape dynamics analysis

Analysis of posture data generated using https://github.com/yha/Elegans/

Includes time-binning, delay-embedding PCAs of populations and individuals, and dimensionality estimation.

## Usage

### Data preparation

The analysis pipeline requires as input developmental stage data and midline data generated by https://github.com/yha/Elegans/, and a list of experiments to be analyzed as a CSV file. 
The CSV file should have columns `name`, `strain` and `DS` (days starvation). Any other columns are ignored. (see `ex-list-example.csv`).
The list of wells in each experiment is taken from the stage data file `stages.toml`. Experiments not listed there are filtered out.

### Running the analysis pipeline locally

Clone or download the repository alongside https://github.com/yha/Elegans/ in the same directory. E.g.,

```sh
elegans-pipeline> git clone https://github.com/yha/Elegans.git
Cloning into 'Elegans'...
[...]
elegans-pipeline> git clone https://github.com/yha/ElegansTimeSeries.git
Cloning into 'ElegansTimeSeries'...
[...]
elegans-pipeline> ls
Elegans  ElegansTimeSeries
```
(alternatively, if you have `Elegans` at a different path, you can point `ElegansTimeSeries` there using `]activate path/to/ElegansTimeSeries` followed by `]dev path/to/Elegans` at the julia REPL)


Modify the paths listed in `scripts/args.toml` under `[paths]` to point to the generated stage and midpoint data, and to the experiment CSV file.
For running the analysis locally, no changes are needed under the `[dist]` section (the default `dist.n_remote = 0` means analysis runs locally. To run analysis remotely, see additional setup below),
but you may want to modify the number of worker processes, according to available memory, by setting the value of `n_local`. 
Each worker processes one condition (strainÃ—ds combination) at a time, and typically consumes up to 0.25GB of memory per individual in the condition.

The analysis pipeline was tested with julia version 1.9.3 on Windows (optionally with remote workers on a Linux machine). 
It is run from the script at `scripts/de_pca_pipeline_dist.jl`. After configuring `scripts/args.toml`, running the script will install required packages and start the pipeline. e.g.
```
julia> include("ElegansTimeSeries/scripts/de_pca_pipeline_dist.jl")
[...]
Progress available at localhost:8108 (copied to clipboard)
```
Visit the address listed on the last line to view the progress of workers.

In case of problems with package installation, you may try to install packages manually using `]activate path/to/ElegansTimeSeries` `]instantiate` at the julia REPL.

### Running the analysis pipeline with remote workers

To use remote workers, some setup steps are required on the server and local machine.
The server and local machine should work on the same directories through a network share.
Setup a shared directory on the server accessible on the local machine, where all input file are available. List its path on the remote in `args.toml` under `dist.remote_root`, and its path on the local machine under `paths.local_root`. List the remote's address under `dist.remote`. E.g., if `/home/user/` on `server` is shared and mapped locally to `U:`, your `args.toml` should read
```toml
[paths]
local_root = "U:/"
# ...
[dist]
remote = "server"
remote_root = "/home/user/"
```
Julia should be available on the remote server at `$remote_root/julia-$VERSION/bin/julia`.
Clone or download the repository alongside https://github.com/yha/Elegans/ in the same directory, as in the instructions above for the local machine. The environment on the remote machine need to be instantiated in advance of running the script using `]activate ElegansTimeSeries` followed by `]instantiate`:
```
elegans-pipeline> git clone https://github.com/yha/Elegans.git
Cloning into 'Elegans'...
[...]
elegans-pipeline> git clone https://github.com/yha/ElegansTimeSeries.git
Cloning into 'ElegansTimeSeries'...
[...]
elegans-pipeline> ls
Elegans  ElegansTimeSeries
elegans-pipeline> ~/julia-1.9.3/bin/julia
[~] ~/julia-1.9.3/bin/julia
               _
   _       _ _(_)_     |  Documentation: https://docs.julialang.org
  (_)     | (_) (_)    |
   _ _   _| |_  __ _   |  Type "?" for help, "]?" for Pkg help.
  | | | | | | |/ _` |  |
  | | |_| | | | (_| |  |  Version 1.9.3 (2023-08-24)
 _/ |\__'_|_|_|\__'_|  |  Official https://julialang.org/ release
|__/                   |

(@v1.9) pkg> activate ElegansTimeSeries/
  Activating project at `~/elegans-pipeline/ElegansTimeSeries`

(ElegansTimeSeries) pkg> instantiate
```
List the location of the repository under `dist.remote_project_root` in `args.toml`, and set `n_remote` to the number of remote workers requires:
```toml
[dist]
# ...
n_remote = 4
# ...
remote_project_root = "elegans-pipeline/ElegansTimeSeries" # resolved relative to `dist.root`
```